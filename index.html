<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canyon Storm Battlefield - Team Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@400;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #E74C3C;
            --secondary: #3498DB;
            --accent: #4ECCA3;
            --dark: #0F3460;
            --darker: #16213E;
            --light: #FFFFFF;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--dark);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(231, 76, 60, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(52, 152, 219, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 90%, rgba(78, 204, 163, 0.1) 0%, transparent 50%);
            animation: pulse 10s ease-in-out infinite;
            z-index: 0;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        .container {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        /* Header */
        header {
            text-align: center;
            margin-bottom: 60px;
            animation: slideDown 0.8s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 3.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 30px rgba(231, 76, 60, 0.5);
        }
        
        .subtitle {
            font-size: 1.3rem;
            color: var(--accent);
            font-weight: 600;
            letter-spacing: 4px;
        }
        
        /* Upload Section */
        .upload-section {
            background: var(--darker);
            border-radius: 20px;
            padding: 50px;
            margin-bottom: 40px;
            border: 2px solid rgba(78, 204, 163, 0.3);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            animation: fadeIn 1s ease-out 0.3s both;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .upload-area {
            border: 3px dashed var(--accent);
            border-radius: 15px;
            padding: 60px 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: rgba(78, 204, 163, 0.05);
        }
        
        .upload-area:hover {
            background: rgba(78, 204, 163, 0.1);
            border-color: var(--light);
            transform: scale(1.02);
        }
        
        .upload-area.dragover {
            background: rgba(78, 204, 163, 0.2);
            border-color: var(--light);
            transform: scale(1.05);
        }
        
        .upload-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .upload-text {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--accent);
        }
        
        .upload-subtext {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        input[type="file"] {
            display: none;
        }
        
        /* Processing Section */
        .processing {
            display: none;
            text-align: center;
            padding: 40px;
            animation: fadeIn 0.5s ease-out;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(78, 204, 163, 0.2);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .processing-text {
            font-size: 1.3rem;
            color: var(--accent);
            font-weight: 600;
        }
        
        /* Results Section */
        .results {
            display: none;
            animation: fadeIn 0.8s ease-out;
        }
        
        .result-card {
            background: var(--darker);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            border: 2px solid rgba(231, 76, 60, 0.3);
            transition: all 0.3s ease;
        }
        
        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
            border-color: var(--primary);
        }
        
        .result-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .download-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--light);
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 700;
            font-family: 'Rajdhani', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(231, 76, 60, 0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .download-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.6);
        }
        
        .download-btn:active {
            transform: translateY(0);
        }
        
        /* Info Section */
        .info-section {
            background: rgba(22, 33, 62, 0.6);
            border-radius: 15px;
            padding: 30px;
            margin-top: 40px;
            border-left: 5px solid var(--accent);
        }
        
        .info-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 15px;
        }
        
        .info-list {
            list-style: none;
            padding: 0;
        }
        
        .info-list li {
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 1.1rem;
        }
        
        .info-list li:before {
            content: "‚ö°";
            margin-right: 10px;
            color: var(--accent);
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }
            
            .upload-section {
                padding: 30px 20px;
            }
            
            .upload-area {
                padding: 40px 20px;
            }
            
            .result-card {
                padding: 20px;
            }
        }
        
        .error {
            background: rgba(231, 76, 60, 0.2);
            border: 2px solid var(--primary);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }
        
        .error-text {
            color: var(--light);
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚öîÔ∏è Canyon Storm ‚öîÔ∏è</h1>
            <p class="subtitle">Team Assignment Generator</p>
        </header>
        
        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üì§</div>
                <div class="upload-text">Upload Your Player Excel File</div>
                <div class="upload-subtext">Click or drag & drop your UBS_players.xlsx file here</div>
                <input type="file" id="fileInput" accept=".xlsx,.xls">
            </div>
            <div class="error" id="error">
                <p class="error-text" id="errorText"></p>
            </div>
        </div>
        
        <div class="processing" id="processing">
            <div class="spinner"></div>
            <p class="processing-text">Processing assignments and generating infographics...</p>
        </div>
        
        <div class="results" id="results">
            <div class="result-card">
                <div class="result-title">üìä Team Assignments Excel</div>
                <p style="margin-bottom: 20px; opacity: 0.8;">Complete player assignments for both Team A and Team B</p>
                <button class="download-btn" id="downloadExcel">‚¨áÔ∏è Download Excel File</button>
            </div>
            
            <div class="result-card">
                <div class="result-title">üì± Team A Mobile Infographic</div>
                <p style="margin-bottom: 20px; opacity: 0.8;">Mobile-optimized visual guide for Team A players</p>
                <button class="download-btn" id="downloadTeamA">‚¨áÔ∏è Download Team A Image</button>
            </div>
            
            <div class="result-card">
                <div class="result-title">üì± Team B Mobile Infographic</div>
                <p style="margin-bottom: 20px; opacity: 0.8;">Mobile-optimized visual guide for Team B players</p>
                <button class="download-btn" id="downloadTeamB">‚¨áÔ∏è Download Team B Image</button>
            </div>
        </div>
        
        <div class="info-section">
            <div class="info-title">üì• Need the Excel Template?</div>
            <p style="margin-bottom: 20px; opacity: 0.9; font-size: 1.1rem;">
                Don't have the player data file? Download our template with instructions and examples!
            </p>
            <button class="download-btn" id="downloadTemplate" style="background: linear-gradient(135deg, #4ECCA3, #3498DB);">
                ‚¨áÔ∏è Download Excel Template
            </button>
        </div>
        
        <div class="info-section" style="margin-top: 30px;">
            <div class="info-title">‚ÑπÔ∏è How It Works</div>
            <ul class="info-list">
                <li>Download the Excel template (or use your existing file)</li>
                <li>Fill in player names, power levels, troop types, and eligibility</li>
                <li>Upload the completed file here</li>
                <li>AI analyzes and creates strategic assignments automatically</li>
                <li>Download Excel + mobile infographics ready to share!</li>
            </ul>
        </div>
    </div>

    <script>
        // Global variables
        let workbook = null;
        let teamAAssignments = [];
        let teamBAssignments = [];
        
        // Zone colors
        const zoneColors = {
            'MIDDLE': '#E74C3C',
            'NORTH': '#3498DB',
            'EAST': '#F39C12',
            'WEST': '#9B59B6',
            'SOUTH': '#95A5A6'
        };
        
        // Upload area handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const processing = document.getElementById('processing');
        const results = document.getElementById('results');
        const errorDiv = document.getElementById('error');
        const errorText = document.getElementById('errorText');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });
        
        function showError(message) {
            errorText.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        function handleFile(file) {
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                showError('Please upload an Excel file (.xlsx or .xls)');
                return;
            }
            
            processing.style.display = 'block';
            errorDiv.style.display = 'none';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    workbook = XLSX.read(e.target.result, { type: 'binary' });
                    processWorkbook();
                } catch (error) {
                    showError('Error reading Excel file: ' + error.message);
                    processing.style.display = 'none';
                }
            };
            reader.readAsBinaryString(file);
        }
        
        function getZone(buildingName) {
            const building = String(buildingName).toUpperCase();
            if (building.includes('MIDDLE')) return 'MIDDLE';
            if (building.includes('NORTH')) return 'NORTH';
            if (building.includes('EAST')) return 'EAST';
            if (building.includes('WEST')) return 'WEST';
            if (building.includes('SOUTH')) return 'SOUTH';
            return 'OTHER';
        }
        
        function processWorkbook() {
            try {
                // Read sheets
                const playersSheet = workbook.Sheets['Players'];
                const teamASheet = workbook.Sheets['Canyon Battlefield - Team A'];
                const teamBSheet = workbook.Sheets['Canyon Battlefield - Team B'];
                
                if (!playersSheet || !teamASheet || !teamBSheet) {
                    showError('Excel file must contain "Players", "Canyon Battlefield - Team A", and "Canyon Battlefield - Team B" sheets');
                    processing.style.display = 'none';
                    return;
                }
                
                // Convert to JSON - skip first 9 rows, use row 10 as header
                const players = XLSX.utils.sheet_to_json(playersSheet, {range: 9});
                
                // Building sheets - skip first 3 rows, use row 4 as header
                const teamABuildings = XLSX.utils.sheet_to_json(teamASheet, {range: 3});
                const teamBBuildings = XLSX.utils.sheet_to_json(teamBSheet, {range: 3});
                
                console.log('Players loaded:', players.length);
                console.log('Sample player:', players[0]);
                console.log('Columns:', Object.keys(players[0] || {}));
                console.log('Team A buildings loaded:', teamABuildings.length);
                console.log('Sample building:', teamABuildings[0]);
                
                // Process Team A
                teamAAssignments = assignPlayers(players, teamABuildings, 'Canon Battlefield - Team A');
                
                // Process Team B
                teamBAssignments = assignPlayers(players, teamBBuildings, 'Canon Battlefield - Team B');
                
                // Validate assignments
                const countA = teamAAssignments.filter(a => a.player).length;
                const countB = teamBAssignments.filter(a => a.player).length;
                
                if (countA === 0 && countB === 0) {
                    showError('NO PLAYERS! Mark players with 1 in Canon Battlefield - Team A or Team B columns.');
                    processing.style.display = 'none';
                    return;
                }
                
                console.log(`Team A: ${countA} players, Team B: ${countB} players`);
                
                // Generate outputs
                setTimeout(() => {
                    processing.style.display = 'none';
                    results.style.display = 'block';
                }, 1500);
                
            } catch (error) {
                showError('Error processing file: ' + error.message);
                processing.style.display = 'none';
            }
        }
        
        function assignPlayers(players, buildings, teamColumn) {
            console.log(`Checking ${teamColumn} for selected players...`);
            
            // Filter eligible players - handle checkbox values: 1, true, 'Y', 'TRUE'
            const eligible = players
                .filter(p => {
                    const val = p[teamColumn];
                    const isSelected = val === 1 || val === true || val === 'Y' || val === 'TRUE' || val === 1.0;
                    if (isSelected) {
                        console.log(`  ‚úì ${p['Player Name']}: ${val} (${typeof val})`);
                    }
                    return isSelected;
                })
                .map(p => ({
                    name: p['Player Name'],
                    power: p['E1 total power(M)'] || 0,
                    troops: p['E1 troops'] || 'Unknown'
                }))
                .sort((a, b) => b.power - a.power);
            
            console.log(`Found ${eligible.length} eligible players for ${teamColumn}`);
            
            // Categorize players by troop type and sort by power
            const playersByType = {
                'Tank': eligible.filter(p => p.troops === 'Tank').sort((a, b) => b.power - a.power),
                'Aero': eligible.filter(p => p.troops === 'Aero').sort((a, b) => b.power - a.power),
                'Missile': eligible.filter(p => p.troops === 'Missile').sort((a, b) => b.power - a.power),
                'Unknown': eligible.filter(p => !['Tank', 'Aero', 'Missile'].includes(p.troops)).sort((a, b) => b.power - a.power)
            };
            
            console.log(`Players by type: Tank=${playersByType.Tank.length}, Aero=${playersByType.Aero.length}, Missile=${playersByType.Missile.length}`);
            
            // Group buildings by name and priority, but keep template order for final output
            const buildingGroups = {};
            const groupOrder = []; // Track template order
            
            buildings.forEach((b, index) => {
                const key = `${b['Buildig Name']}_${b['Priority']}`;
                if (!buildingGroups[key]) {
                    buildingGroups[key] = [];
                    groupOrder.push({key, index, priority: b['Priority']}); // Remember order AND priority
                }
                buildingGroups[key].push(b);
            });
            
            // Sort groups by PRIORITY for assignment (P1 first, then P2, etc.)
            const sortedForAssignment = [...groupOrder].sort((a, b) => a.priority - b.priority);
            
            console.log('Assigning players by priority: P1 ‚Üí P2 ‚Üí P3 ‚Üí P4 ‚Üí P5 ‚Üí P6');
            
            // Helper function to get next best player of specific type
            function getPlayer(type) {
                if (playersByType[type] && playersByType[type].length > 0) {
                    return playersByType[type].shift();
                }
                return null;
            }
            
            // Helper function to get next best player (any type)
            function getAnyPlayer() {
                // Try Tank, then Aero, then Missile, then Unknown
                for (let type of ['Tank', 'Aero', 'Missile', 'Unknown']) {
                    const player = getPlayer(type);
                    if (player) return player;
                }
                return null;
            }
            
            // Helper function to get complementary troop type for mixing
            function getComplementaryPlayer(firstTroop) {
                if (firstTroop === 'Tank') {
                    // Tank pairs well with Aero or Missile
                    return getPlayer('Aero') || getPlayer('Missile') || getAnyPlayer();
                } else if (firstTroop === 'Aero') {
                    // Aero pairs well with Tank or Missile
                    return getPlayer('Tank') || getPlayer('Missile') || getAnyPlayer();
                } else if (firstTroop === 'Missile') {
                    // Missile pairs well with Tank or Aero
                    return getPlayer('Tank') || getPlayer('Aero') || getAnyPlayer();
                }
                return getAnyPlayer();
            }
            
            // Assign players to buildings by priority
            const assignmentMap = {}; // Will store assignments by key
            
            sortedForAssignment.forEach(({key, priority}) => {
                const group = buildingGroups[key];
                const building = group[0];
                const count = group.length;
                const buildingName = building['Buildig Name'];
                
                console.log(`\nAssigning P${priority}: ${buildingName} (${count} slots)`);
                
                // Select best players for this building
                const selected = [];
                
                if (count === 1) {
                    // Single position: take highest available power
                    const player = getAnyPlayer();
                    if (player) {
                        selected.push(player);
                        console.log(`  ‚Üí ${player.name} (${player.power}M, ${player.troops})`);
                    }
                } else if (count === 2) {
                    // Two positions: prioritize troop mixing
                    const player1 = getAnyPlayer();
                    if (player1) {
                        selected.push(player1);
                        console.log(`  ‚Üí ${player1.name} (${player1.power}M, ${player1.troops})`);
                        
                        // Get complementary troop type
                        const player2 = getComplementaryPlayer(player1.troops);
                        if (player2) {
                            selected.push(player2);
                            const mixed = player1.troops !== player2.troops;
                            console.log(`  ‚Üí ${player2.name} (${player2.power}M, ${player2.troops})${mixed ? ' ‚úì Mixed troops' : ''}`);
                        }
                    }
                } else {
                    // More than 2 positions: mix types and balance power
                    while (selected.length < count) {
                        const player = getAnyPlayer();
                        if (!player) break;
                        selected.push(player);
                        console.log(`  ‚Üí ${player.name} (${player.power}M, ${player.troops})`);
                    }
                }
                
                // Store assignments for this building
                assignmentMap[key] = {group, selected};
            });
            
            // Count total assigned
            let totalAssigned = 0;
            Object.values(assignmentMap).forEach(({selected}) => {
                totalAssigned += selected.length;
            });
            
            // Build final assignments array in TEMPLATE ORDER (not priority order)
            const assignments = [];
            groupOrder.forEach(({key}) => {
                const {group, selected} = assignmentMap[key];
                
                group.forEach((b, idx) => {
                    const player = selected[idx];
                    assignments.push({
                        building: b['Buildig Name'],
                        priority: b['Priority'],
                        player: player ? player.name : '',
                        power: player ? player.power : 0,
                        troops: player ? player.troops : '',
                        description: b['Description'] || '',
                        zone: getZone(b['Buildig Name'])
                    });
                });
            });
            
            console.log(`\n‚úÖ Assigned ${totalAssigned} players`);
            console.log(`üìä Assignment strategy:`);
            console.log(`   - P1/P2: Highest power players`);
            console.log(`   - P3-P6: Balanced power with troop mixing`);
            console.log(`üìã Output order: Template order (zone-based)`);
            
            return assignments;
        }
        
        // Download Excel
        document.getElementById('downloadExcel').addEventListener('click', () => {
            const wb = XLSX.utils.book_new();
            
            // Team A sheet
            const teamAData = teamAAssignments.map(a => ({
                'Building Name': a.building,
                'Priority': a.priority,
                'Assigned Player': a.player,
                'E1 Total Power(M)': a.power,
                'E1 Troops': a.troops,
                'Description': a.description
            }));
            const wsA = XLSX.utils.json_to_sheet(teamAData);
            XLSX.utils.book_append_sheet(wb, wsA, 'Team A');
            
            // Team B sheet
            const teamBData = teamBAssignments.map(a => ({
                'Building Name': a.building,
                'Priority': a.priority,
                'Assigned Player': a.player,
                'E1 Total Power(M)': a.power,
                'E1 Troops': a.troops,
                'Description': a.description
            }));
            const wsB = XLSX.utils.json_to_sheet(teamBData);
            XLSX.utils.book_append_sheet(wb, wsB, 'Team B');
            
            XLSX.writeFile(wb, 'canyon_battlefield_assignments.xlsx');
        });
        
        // Download Team A Image
        document.getElementById('downloadTeamA').addEventListener('click', () => {
            generateInfographic(teamAAssignments, 'TEAM A');
        });
        
        // Download Team B Image
        document.getElementById('downloadTeamB').addEventListener('click', () => {
            generateInfographic(teamBAssignments, 'TEAM B');
        });
        
        function generateInfographic(assignments, teamName) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Table-style dimensions
            const width = 1400;
            const rowHeight = 45;
            const headerHeight = 60;
            const titleHeight = 80;
            const numRows = assignments.length;
            
            const height = titleHeight + headerHeight + (numRows * rowHeight) + 50;
            
            canvas.width = width;
            canvas.height = height;
            
            // Priority colors
            const priorityColors = {
                1: '#FFB6C1', 2: '#FFB6C1',
                3: '#90EE90', 6: '#90EE90',
                4: '#ADD8E6', 5: '#ADD8E6'
            };
            
            // White background
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, width, height);
            
            // Title
            ctx.fillStyle = '#2C3E50';
            ctx.fillRect(0, 0, width, titleHeight);
            ctx.font = 'bold 36px Arial';
            ctx.fillStyle = '#FFFFFF';
            ctx.textAlign = 'center';
            ctx.fillText(`${teamName} - CANYON STORM ASSIGNMENTS`, width/2, titleHeight/2 + 12);
            
            let yPos = titleHeight;
            
            // Column definitions
            const columns = [
                {name: 'Building Name', width: 200, align: 'left'},
                {name: 'Priority', width: 80, align: 'center'},
                {name: 'Names', width: 180, align: 'left'},
                {name: 'Description', width: 940, align: 'left'}
            ];
            
            // Header row
            ctx.fillStyle = '#34495E';
            ctx.fillRect(0, yPos, width, headerHeight);
            
            let xPos = 0;
            ctx.font = 'bold 14px Arial';
            ctx.fillStyle = '#FFFFFF';
            
            columns.forEach(col => {
                // Vertical line
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(xPos, yPos);
                ctx.lineTo(xPos, yPos + headerHeight);
                ctx.stroke();
                
                // Header text
                if (col.align === 'center') {
                    ctx.textAlign = 'center';
                    ctx.fillText(col.name, xPos + col.width/2, yPos + headerHeight/2 + 5);
                } else {
                    ctx.textAlign = 'left';
                    ctx.fillText(col.name, xPos + 10, yPos + headerHeight/2 + 5);
                }
                
                xPos += col.width;
            });
            
            // Right border of header
            ctx.beginPath();
            ctx.moveTo(width, yPos);
            ctx.lineTo(width, yPos + headerHeight);
            ctx.stroke();
            
            // Bottom border of header
            ctx.beginPath();
            ctx.moveTo(0, yPos + headerHeight);
            ctx.lineTo(width, yPos + headerHeight);
            ctx.stroke();
            
            yPos += headerHeight;
            
            // Data rows
            ctx.font = '12px Arial';
            ctx.lineWidth = 1;
            
            assignments.forEach((row, idx) => {
                const priority = row.priority;
                const bgColor = priorityColors[priority] || '#FFFFFF';
                
                // Row background
                ctx.fillStyle = bgColor;
                ctx.fillRect(0, yPos, width, rowHeight);
                
                // Row data
                const building = row.building || '';
                const priorityStr = priority ? String(priority) : '';
                const player = row.player || '';
                const description = row.description || '';
                
                const rowData = [
                    {text: building, width: columns[0].width, align: columns[0].align},
                    {text: priorityStr, width: columns[1].width, align: columns[1].align},
                    {text: player, width: columns[2].width, align: columns[2].align},
                    {text: description.length > 120 ? description.substring(0, 117) + '...' : description, width: columns[3].width, align: columns[3].align}
                ];
                
                xPos = 0;
                ctx.fillStyle = '#000000';
                
                rowData.forEach(cell => {
                    // Vertical line
                    ctx.beginPath();
                    ctx.moveTo(xPos, yPos);
                    ctx.lineTo(xPos, yPos + rowHeight);
                    ctx.stroke();
                    
                    // Cell text
                    if (cell.align === 'center') {
                        ctx.textAlign = 'center';
                        ctx.fillText(cell.text, xPos + cell.width/2, yPos + rowHeight/2 + 4);
                    } else {
                        ctx.textAlign = 'left';
                        ctx.fillText(cell.text, xPos + 10, yPos + rowHeight/2 + 4);
                    }
                    
                    xPos += cell.width;
                });
                
                // Right border
                ctx.beginPath();
                ctx.moveTo(width, yPos);
                ctx.lineTo(width, yPos + rowHeight);
                ctx.stroke();
                
                // Bottom border
                ctx.beginPath();
                ctx.moveTo(0, yPos + rowHeight);
                ctx.lineTo(width, yPos + rowHeight);
                ctx.stroke();
                
                yPos += rowHeight;
            });
            
            // Footer
            yPos += 10;
            ctx.font = '12px Arial';
            ctx.fillStyle = '#7F8C8D';
            ctx.textAlign = 'left';
            ctx.fillText('Subs join at the same building of the main player leaving / Subs treten im selben Geb√§ude ein, in dem der Hauptspieler das Spiel verl√§sst', 20, yPos);
            
            // Download using dataURL (more reliable than blob)
            const dataURL = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = dataURL;
            a.download = `${teamName.toLowerCase().replace(' ', '_')}_table.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? [
                parseInt(result[1], 16),
                parseInt(result[2], 16),
                parseInt(result[3], 16)
            ] : [0, 0, 0];
        }
        
        // Download Template
        document.getElementById('downloadTemplate').addEventListener('click', () => {
            // Create template workbook
            const wb = XLSX.utils.book_new();
            
            // Players sheet with instructions
            const playersData = [
                ['INSTRUCTIONS:'],
                ['1. Fill in player names in column B (Player Name)'],
                ['2. Fill in E1 troops in column D (Tank, Aero, or Missile)'],
                ['3. Fill in E1 total power in column E (numeric value, e.g., 71.0)'],
                ['4. Mark with 1 in column F (Team A) or column G (Team B) - 1 = selected, 0 = not selected'],
                [''],
                ['Start entering your player data below (row 9 onwards):'],
                ['Mark players with checkbox (1=checked) in column F (Team A) or G (Team B)'],
                [''],
                ['', 'Player Name', 'Total Hero Power(M)', 'E1 troops', 'E1 total power(M)', 'Canon Battlefield - Team A', 'Canon Battlefield - Team B'],
                [1, 'Example Player', 95, 'Tank', 65, 1, 0],
                [2, '', '', '', '', 0, 0],
            ];
            const wsPlayers = XLSX.utils.aoa_to_sheet(playersData);
            
            // Set column widths for new simplified structure
            wsPlayers['!cols'] = [
                {wch: 8}, {wch: 20}, {wch: 18}, {wch: 12}, {wch: 18},
                {wch: 28}, {wch: 28}
            ];
            
            XLSX.utils.book_append_sheet(wb, wsPlayers, 'Players');
            
            // Team A sheet
            const teamAData = [
                ['TEAM A ASSIGNMENTS - This sheet will be AUTO-FILLED by the generator'],
                ['Do not manually edit this sheet. Upload to the Canyon Storm Generator to auto-populate.'],
                [''],
                ['Buildig Name', 'Priority', 'Names', 'Description'],
                ['East Serum Factory 2', 3, '', 'EAST serum Factory 2 (SOUTH until EAST open)'],
                ['East Defense System 2', 3, '', 'EAST Defense system 2 (SOUTH until EAST open)'],
                ['East Roaming', 5, '', 'EAST roaming (help SOUTH until EAST buidings open)'],
                ['South Sample 1', 6, '', 'SOUTH Sample 1 (you can move in all south zone after first teleport)'],
                ['South Sample 2', 6, '', 'SOUTH Sample 2 (you can move in all south zone after first teleport)'],
                ['South Sample 3', 6, '', 'SOUTH Sample 3 (you can move in all south zone after first teleport)'],
                ['South Sample 4', 6, '', 'SOUTH Sample 4 (you can move in all south zone after first teleport)'],
                ['West Serum Factory 2', 3, '', 'WEST Serum Factory 1 ( NORTH until WEST open)'],
                ['West Defense System 2', 3, '', 'WEST Defense system 1 ( NORTH until WEST open)'],
                ['West Roaming ', 5, '', 'WEST Roaming (help  NORTH until WEST buildings open)'],
                ['North Data Center 1', 4, '', 'NORTH Data Center 1'],
                ['North Data Center 2', 4, '', 'NORTH Data Center 2'],
                ['North Roaming', 5, '', 'NORTH Roaming (help NORTH players)'],
                ['Middle Power Tower', 1, '', 'MIDDLE POWER TOWER'],
                ['Middle Power Tower', 2, '', 'MIDDLE POWER TOWER'],
                ['Middle Power Tower', 1, '', 'MIDDLE POWER TOWER'],
                ['Middle Virus Lab', 1, '', 'MIDDLE VIRUS LAB(until Virus Lab open, help where is needed if middle power tower is safe'],
                ['Middle Virus Lab', 1, '', 'MIDDLE VIRUS LAB(until Virus Lab open, help where is needed if middle power tower is safe'],
                ['Middle Virus Lab', 2, '', 'MIDDLE VIRUS LAB(until Virus Lab open, help where is needed if middle power tower is safe'],
                ['Middle Virus Lab', 2, '', 'MIDDLE VIRUS LAB(until Virus Lab open, help where is needed if middle power tower is safe'],
            ];
            const wsTeamA = XLSX.utils.aoa_to_sheet(teamAData);
            wsTeamA['!cols'] = [{wch: 25}, {wch: 10}, {wch: 20}, {wch: 80}];
            XLSX.utils.book_append_sheet(wb, wsTeamA, 'Canyon Battlefield - Team A');
            
            // Team B sheet (same structure)
            const teamBData = [
                ['TEAM B ASSIGNMENTS - This sheet will be AUTO-FILLED by the generator'],
                ['Do not manually edit this sheet. Upload to the Canyon Storm Generator to auto-populate.'],
                [''],
                ['Buildig Name', 'Priority', 'Names', 'Description'],
                ['East Serum Factory 2', 3, '', 'EAST serum Factory 2 (SOUTH until EAST open)'],
                ['East Defense System 2', 3, '', 'EAST Defense system 2 (SOUTH until EAST open)'],
                ['East Roaming', 5, '', 'EAST roaming (help SOUTH until EAST buidings open)'],
                ['South Sample 1', 6, '', 'SOUTH Sample 1 (you can move in all south zone after first teleport)'],
                ['South Sample 2', 6, '', 'SOUTH Sample 2 (you can move in all south zone after first teleport)'],
                ['South Sample 3', 6, '', 'SOUTH Sample 3 (you can move in all south zone after first teleport)'],
                ['South Sample 4', 6, '', 'SOUTH Sample 4 (you can move in all south zone after first teleport)'],
                ['West Serum Factory 2', 3, '', 'WEST Serum Factory 1 ( NORTH until WEST open)'],
                ['West Defense System 2', 3, '', 'WEST Defense system 1 ( NORTH until WEST open)'],
                ['West Roaming', 5, '', 'WEST Roaming (help  NORTH until WEST buildings open)'],
                ['North Data Center 1', 4, '', 'NORTH Data Center 1'],
                ['North Data Center 2', 4, '', 'NORTH Data Center 2'],
                ['North Roaming', 5, '', 'NORTH Roaming (help NORTH players)'],
                ['Middle Power Tower', 1, '', 'MIDDLE POWER TOWER'],
                ['Middle Power Tower', 2, '', 'MIDDLE POWER TOWER'],
                ['Middle Power Tower', 1, '', 'MIDDLE POWER TOWER'],
                ['Middle Virus Lab', 1, '', 'MIDDLE VIRUS LAB(until Virus Lab open, help where is needed if middle power tower is safe'],
                ['Middle Virus Lab', 1, '', 'MIDDLE VIRUS LAB(until Virus Lab open, help where is needed if middle power tower is safe'],
                ['Middle Virus Lab', 2, '', 'MIDDLE VIRUS LAB(until Virus Lab open, help where is needed if middle power tower is safe'],
                ['Middle Virus Lab', 2, '', 'MIDDLE VIRUS LAB(until Virus Lab open, help where is needed if middle power tower is safe'],
            ];
            const wsTeamB = XLSX.utils.aoa_to_sheet(teamBData);
            wsTeamB['!cols'] = [{wch: 25}, {wch: 10}, {wch: 20}, {wch: 80}];
            XLSX.utils.book_append_sheet(wb, wsTeamB, 'Canyon Battlefield - Team B');
            
            // Download
            XLSX.writeFile(wb, 'canyon_battlefield_template.xlsx');
        });
    </script>
</body>
</html>
